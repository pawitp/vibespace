<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>vibespace login</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, sans-serif; max-width: 760px; margin: 2rem auto; padding: 0 1rem; line-height: 1.45; }
    button { padding: 0.55rem 0.9rem; border: 1px solid #bbb; border-radius: 8px; background: #fff; cursor: pointer; }
    code { background: #f3f3f3; padding: 0.15rem 0.35rem; border-radius: 4px; }
    #status { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>vibespace</h1>
  <p>Passkey login is required.</p>
  <p><button id="login" type="button">Login with passkey</button></p>
  <p id="status"></p>
  <script>
    const loginButton = document.getElementById("login");
    const statusNode = document.getElementById("status");

    loginButton.addEventListener("click", async () => {
      setStatus("Requesting challenge...");
      try {
        const optionsRes = await fetch("/auth/passkey/login/options", {
          method: "POST",
          credentials: "include"
        });
        if (!optionsRes.ok) {
          setStatus("Failed to request login options.");
          return;
        }

        const optionsJson = await optionsRes.json();
        const publicKey = decodePublicKeyOptions(optionsJson.publicKey);
        const credential = await navigator.credentials.get({ publicKey });
        if (!credential) {
          setStatus("No passkey response.");
          return;
        }

        setStatus("Verifying...");
        const verifyRes = await fetch("/auth/passkey/login/verify", {
          method: "POST",
          credentials: "include",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            state: optionsJson.state,
            credential: encodeAssertion(credential)
          })
        });
        if (!verifyRes.ok) {
          const err = await safeJson(verifyRes);
          setStatus(err.error || "Login failed.");
          return;
        }

        window.location.href = getReturnToTarget();
      } catch (error) {
        setStatus(String(error && error.message ? error.message : error));
      }
    });

    function setStatus(message) {
      statusNode.textContent = message;
    }

    function decodePublicKeyOptions(publicKey) {
      return {
        ...publicKey,
        challenge: b64ToBuf(publicKey.challenge),
        allowCredentials: Array.isArray(publicKey.allowCredentials)
          ? publicKey.allowCredentials.map((cred) => ({ ...cred, id: b64ToBuf(cred.id) }))
          : []
      };
    }

    function encodeAssertion(credential) {
      return {
        id: credential.id,
        type: credential.type,
        rawId: bufToB64(credential.rawId),
        response: {
          clientDataJSON: bufToB64(credential.response.clientDataJSON),
          authenticatorData: bufToB64(credential.response.authenticatorData),
          signature: bufToB64(credential.response.signature),
          userHandle: credential.response.userHandle ? bufToB64(credential.response.userHandle) : null
        }
      };
    }

    function bufToB64(buf) {
      const bytes = new Uint8Array(buf);
      let str = "";
      for (let i = 0; i < bytes.length; i += 1) str += String.fromCharCode(bytes[i]);
      return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }

    function b64ToBuf(str) {
      const padded = str.replace(/-/g, "+").replace(/_/g, "/") + "===".slice((str.length + 3) % 4);
      const raw = atob(padded);
      const out = new Uint8Array(raw.length);
      for (let i = 0; i < raw.length; i += 1) out[i] = raw.charCodeAt(i);
      return out.buffer;
    }

    async function safeJson(res) {
      try { return await res.json(); } catch { return { error: "Request failed" }; }
    }

    function getReturnToTarget() {
      const params = new URLSearchParams(window.location.search);
      const returnTo = params.get("returnTo") || "";
      if (!returnTo.startsWith("/")) return "/";
      if (returnTo.startsWith("//")) return "/";
      if (returnTo === "/auth/login") return "/";
      return returnTo;
    }
  </script>
</body>
</html>
